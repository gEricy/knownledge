# 双11秒杀系统设计

写在最前，双11秒杀系统采用的核心技术：

- Redis缓存，可以做多级缓存
- ZK分布式锁，保证减少库存的正确性（[分布式锁](https://github.com/gEricy/knownledge/blob/master/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81.md)）

## 1. 简述

什么是秒杀系统？即：商家为了大促活动，比如双11，在某个时间点（12:00），售出少量的某个商品（product_id）。

秒杀系统说起来很简单，就是数据库中保存了商品product_id的数量Cnt，当用户点击下单时，将会向数据库发请求，此时数据库收到请求后，会将该商品的数量减一，当减为0时，表示商品售空。

压测工具：Jmeter

---

超高并发请求，对同一件商品，减库存，(生成订单，增加积分)

### 系统设计

1. 微服务架构

   - 一般都是微服务，整个系统拆分成多个小服务：订单中心、库存中心、积分中心
   - 各个服务采用RPC的方式连接起来
   - 分布式事务一致性：采用 TCC 保证
2. 分布式锁：减库存
3. 水平扩展
   - 对于秒杀业务，水平扩展节点，增加节点的支撑能力
4. 冷热分离

   - 采用Ngnix做负载均衡，将秒杀业务、普通业务分离到不同的集群上处理
5. 限流

   - 客户端层：限制用户发秒杀请求的次数，防止恶意刷单（比如：秒杀发起后，按钮变灰）
   - 数据库层：限制同一时间访问数据库的次数，避免击垮数据库
6. 降级

   - 临时关闭一些没那么重要的功能，比如秒杀商品的转赠功能、红包的提现功能，待秒杀峰值过了，设置开关，再动态开放这些次要的功能
7. 熔断
   - 当实在扛不住请求压力时，为了防止系统挂掉，还需要添加熔断机制作为兜底，直接终止秒杀系统服务
8. （Redis）抢单减库存

   - 缓存热点数据：库存

   - Redis分布式锁：避免超卖
9. （MQ）异步、解耦、削峰

   - 抢单减库存成功后，把任务丢到MQ中，异步的等待各个子系统处理（订单系统、库存系统、支付系统、优惠券系统）
   - MQ堆积订单，保护订单处理层的负载，Consumer根据自己的消费能力来取Task，实际上下游的压力就可控了

